// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DATABASE_URL_DIRECT")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/**
 * =========================
 * CORE v1 (Multi-tenant)
 * =========================
 */

enum UserRole {
  OWNER
  ADMIN
  DOCTOR
  STAFF
}

enum MembershipStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum EncounterStatus {
  OPEN
  LOCKED
  SIGNED
}

enum SpecialtyType {
  GENERAL
  ENDODONTICS
  PERIODONTICS
  PROSTHODONTICS
  ORTHODONTICS
  IMPLANTS
  ORAL_SURGERY
  PEDIATRIC
  RADIOLOGY
}

/**
 * =========================
 * TENANCY MODELS
 * =========================
 */

model Clinic {
  id String @id @default(uuid())

  /// Código corto del tenant (ej: "Ortho-Club"). Único global.
  code String @unique

  name      String
  country   String?
  city      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Memberships / Locations
  members         ClinicMember[]
  locations       Location[]
  locationMembers LocationMember[] // <-- RELACION INVERSA requerida por Prisma

  // Clinical
  patients   Patient[]
  encounters Encounter[]
  audits     AuditLog[]

  // ADIE Network
  networkConsults NetworkConsult[]

  @@index([createdAt])
}

model User {
  id String @id @default(uuid())

  /// Login principal: email global único
  email    String  @unique
  fullName String?
  isActive Boolean @default(true)

  /// Auth (Email + Password)
  passwordHash     String?
  failedLoginCount Int       @default(0)
  lockedUntil      DateTime?
  lastLoginAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Memberships (multi-clinic / multi-location)
  clinicMemberships   ClinicMember[]
  locationMemberships LocationMember[]

  // Provider profile (opcional; 1:1 con user)
  provider ProviderProfile?

  // ADIE Network (optional back-relations)
  networkConsults NetworkConsult[]    @relation("NetworkConsultAuthor")
  networkMessages NetworkMessage[]    @relation("NetworkMessageAuthor")
  networkUploads  NetworkAttachment[] @relation("NetworkAttachmentUploader")

  // Encounters where this user is the provider (optional)
  encountersAsProvider Encounter[] @relation("EncounterProvider")

  @@index([isActive])
}

model ClinicMember {
  id       String           @id @default(uuid())
  clinicId String
  userId   String
  role     UserRole         @default(STAFF)
  status   MembershipStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clinicId, userId])
  @@index([clinicId, role])
  @@index([clinicId, status])
  @@index([userId])
}

model Location {
  id       String @id @default(uuid())
  clinicId String

  name     String
  city     String?
  country  String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  // Access control by location (optional)
  members LocationMember[] // <-- RELACION INVERSA requerida por Prisma

  // Future linking (optional)
  patients   Patient[]
  encounters Encounter[]

  @@index([clinicId, isActive])
  @@index([clinicId, createdAt])
}

model LocationMember {
  id         String @id @default(uuid())
  clinicId   String
  locationId String
  userId     String

  createdAt DateTime @default(now())

  clinic   Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([clinicId])
  @@index([locationId])
  @@index([userId])
}

/**
 * =========================
 * PROVIDERS (optional)
 * =========================
 */

model ProviderProfile {
  id            String  @id @default(uuid())
  userId        String  @unique
  licenseNumber String?

  /// Especialidad principal opcional (UI)
  primarySpecialty SpecialtyType?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialties ProviderSpecialty[]

  @@index([primarySpecialty])
}

model ProviderSpecialty {
  id         String        @id @default(uuid())
  providerId String
  specialty  SpecialtyType

  createdAt DateTime @default(now())

  provider ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, specialty])
  @@index([specialty])
}

/**
 * =========================
 * CLINICAL
 * =========================
 */

model Patient {
  id       String @id @default(uuid())
  clinicId String

  /// Si quieres amarrar paciente a una sede específica (opcional)
  locationId String?

  // ID que pone el paciente (único por clínica)
  adieId String

  firstName      String
  lastName       String
  secondLastName String?
  dateOfBirth    DateTime?
  genderIdentity String?

  email   String?
  country String?
  city    String?

  mobilePhoneE164    String?
  otherPhoneE164     String?
  emergencyPhoneE164 String?

  relationship String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic   Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  encounters Encounter[]

  // ADIE Network (future linking)
  networkConsults NetworkConsult[]

  @@unique([clinicId, adieId])
  @@index([clinicId, lastName, firstName])
  @@index([clinicId, createdAt])
  @@index([locationId])
}

model Encounter {
  id        String @id @default(uuid())
  clinicId  String
  patientId String

  /// Sede (opcional)
  locationId String?

  /// Provider (User global) opcional
  providerUserId String?

  status EncounterStatus @default(OPEN)

  chiefComplaint String?
  notes          String?

  startedAt DateTime  @default(now())
  closedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic   Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  providerUser User? @relation("EncounterProvider", fields: [providerUserId], references: [id], onDelete: SetNull)

  specialtyNotes SpecialtyNote[]
  documents      Document[]
  aiOutputs      AIOutput[]

  @@index([clinicId, patientId, startedAt])
  @@index([clinicId, status])
  @@index([locationId])
  @@index([providerUserId])
}

model SpecialtyNote {
  id          String        @id @default(uuid())
  encounterId String
  specialty   SpecialtyType

  data    Json
  summary String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId, specialty])
}

model Document {
  id          String @id @default(uuid())
  encounterId String

  type     String
  url      String
  metadata Json?

  createdAt DateTime @default(now())

  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId, type])
}

model AIOutput {
  id          String @id @default(uuid())
  encounterId String

  kind      String
  model     String?
  inputHash String?
  output    String

  createdAt DateTime @default(now())

  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId, kind, createdAt])
}

model AuditLog {
  id       String @id @default(uuid())
  clinicId String

  actorUserId String?

  action   String
  entity   String
  entityId String?
  meta     Json?

  createdAt DateTime @default(now())

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId, createdAt])
  @@index([clinicId, entity, entityId])
}

/**
 * =========================
 * ADIE Network (v1)
 * =========================
 */

enum NetworkUrgency {
  ROUTINE
  URGENT
}

enum NetworkConsultStatus {
  OPEN
  RESOLVED
}

enum NetworkAttachmentKind {
  IMAGE
  PDF
  FILE
}

model NetworkConsult {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant guardrail
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  // Optional: link to a Patient when the consult is about a specific case
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  title     String
  question  String
  specialty SpecialtyType        @default(GENERAL)
  urgency   NetworkUrgency       @default(ROUTINE)
  status    NetworkConsultStatus @default(OPEN)

  // Author (snapshot + optional relation)
  authorNameSnapshot String
  authorUserId       String?
  authorUser         User?   @relation("NetworkConsultAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)

  messages    NetworkMessage[]
  attachments NetworkAttachment[]

  @@index([clinicId, createdAt])
  @@index([clinicId, specialty])
  @@index([clinicId, urgency])
  @@index([clinicId, status])
  @@index([patientId])
}

model NetworkMessage {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  consultId String
  consult   NetworkConsult @relation(fields: [consultId], references: [id], onDelete: Cascade)

  // Author (snapshot + optional relation)
  authorNameSnapshot String
  authorUserId       String?
  authorUser         User?   @relation("NetworkMessageAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)

  body String

  @@index([consultId, createdAt])
}

model NetworkAttachment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  consultId String
  consult   NetworkConsult @relation(fields: [consultId], references: [id], onDelete: Cascade)

  // Uploader (snapshot + optional relation)
  uploadedByNameSnapshot String?
  uploadedByUserId       String?
  uploadedByUser         User?   @relation("NetworkAttachmentUploader", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  kind NetworkAttachmentKind @default(IMAGE)
  url  String
  mime String?

  @@index([consultId])
  @@index([createdAt])
}
