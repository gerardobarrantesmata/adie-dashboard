generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DATABASE_URL_DIRECT")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Clinic {
  id              String           @id @default(uuid())
  name            String
  country         String?
  city            String?
  /// Código corto del tenant (ej: "clinica-hermano"). Único global.
  code            String           @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Multi-location + membership
  locations       Location[]
  members         ClinicMember[]
  locationMembers LocationMember[]

  // Existing tenant-scoped data
  audits          AuditLog[]
  encounters      Encounter[]
  networkConsults NetworkConsult[]
  patients        Patient[]

  @@index([createdAt])
}

model Location {
  id        String   @id @default(uuid())
  clinicId  String
  name      String
  country   String?
  city      String?
  address1  String?
  address2  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic     Clinic      @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patients   Patient[]
  encounters Encounter[]

  members LocationMember[]

  @@unique([clinicId, name])
  @@index([clinicId, isActive])
  @@index([clinicId, createdAt])
}

model User {
  id               String              @id @default(uuid())
  email            String              @unique
  fullName         String?
  isActive         Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  failedLoginCount Int                 @default(0)
  lastLoginAt      DateTime?
  lockedUntil      DateTime?

  /// Auth (Email + Password)
  passwordHash     String?

  // Memberships (doctor can belong to multiple clinics)
  clinicMemberships   ClinicMember[]
  locationMemberships LocationMember[]

  // Existing relations
  networkUploads   NetworkAttachment[] @relation("NetworkAttachmentUploader")
  networkConsults  NetworkConsult[]    @relation("NetworkConsultAuthor")
  networkMessages  NetworkMessage[]    @relation("NetworkMessageAuthor")
  provider         ProviderProfile?

  @@index([isActive])
  @@index([createdAt])
}

model ClinicMember {
  id            String           @id @default(uuid())
  clinicId      String
  userId        String
  role          UserRole         @default(STAFF)
  status        MembershipStatus @default(ACTIVE)

  /// Who enrolled/invited this user (admin)
  invitedByUserId String?

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  clinic        Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Optional relation to inviter (no cascade to avoid accidental deletes)
  invitedByUser User?            @relation("ClinicMemberInvitedBy", fields: [invitedByUserId], references: [id], onDelete: SetNull)

  @@unique([clinicId, userId])
  @@index([clinicId, role])
  @@index([clinicId, status])
  @@index([userId, createdAt])
}

model LocationMember {
  id         String   @id @default(uuid())
  clinicId   String
  locationId String
  userId     String
  createdAt  DateTime @default(now())

  clinic   Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([locationId, userId])
  @@index([clinicId, userId])
  @@index([clinicId, locationId])
}

model ProviderProfile {
  id               String              @id @default(uuid())
  userId           String              @unique
  licenseNumber    String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  /// Especialidad “principal” opcional (UI), pero permitimos múltiples via join table
  primarySpecialty SpecialtyType?
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialties      ProviderSpecialty[]

  @@index([primarySpecialty])
}

model ProviderSpecialty {
  id         String          @id @default(uuid())
  providerId String
  specialty  SpecialtyType
  createdAt  DateTime        @default(now())
  provider   ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, specialty])
  @@index([specialty])
}

model Patient {
  id                 String           @id @default(uuid())
  clinicId           String
  locationId         String?
  adieId             String
  firstName          String
  lastName           String
  secondLastName     String?
  dateOfBirth        DateTime?
  genderIdentity     String?
  email              String?
  country            String?
  city               String?
  mobilePhoneE164    String?
  otherPhoneE164     String?
  emergencyPhoneE164 String?
  relationship       String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  encounters         Encounter[]
  networkConsults    NetworkConsult[]

  clinic             Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  location           Location?        @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@unique([clinicId, adieId])
  @@index([clinicId, lastName, firstName])
  @@index([clinicId, createdAt])
  @@index([clinicId, locationId])
}

model Encounter {
  id             String          @id @default(uuid())
  clinicId       String
  locationId     String?
  patientId      String

  /// Provider is a global user; access is controlled by ClinicMember at app level
  providerUserId String?

  status         EncounterStatus @default(OPEN)
  chiefComplaint String?
  notes          String?
  startedAt      DateTime        @default(now())
  closedAt       DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  aiOutputs      AIOutput[]
  documents      Document[]
  specialtyNotes SpecialtyNote[]

  clinic         Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  location       Location?       @relation(fields: [locationId], references: [id], onDelete: SetNull)
  patient        Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([clinicId, patientId, startedAt])
  @@index([clinicId, status])
  @@index([clinicId, locationId])
}

model SpecialtyNote {
  id          String        @id @default(uuid())
  encounterId String
  specialty   SpecialtyType
  data        Json
  summary     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  encounter   Encounter     @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId, specialty])
}

model Document {
  id          String    @id @default(uuid())
  encounterId String
  type        String
  url         String
  metadata    Json?
  createdAt   DateTime  @default(now())
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId, type])
}

model AIOutput {
  id          String    @id @default(uuid())
  encounterId String
  kind        String
  model       String?
  inputHash   String?
  output      String
  createdAt   DateTime  @default(now())
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId, kind, createdAt])
}

model AuditLog {
  id          String   @id @default(uuid())
  clinicId    String
  actorUserId String?
  action      String
  entity      String
  entityId    String?
  meta        Json?
  createdAt   DateTime @default(now())
  clinic      Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId, createdAt])
  @@index([clinicId, entity, entityId])
}

model NetworkConsult {
  id                 String               @id @default(uuid())
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  clinicId           String
  patientId          String?
  title              String
  question           String
  specialty          SpecialtyType        @default(GENERAL)
  urgency            NetworkUrgency       @default(ROUTINE)
  status             NetworkConsultStatus @default(OPEN)
  authorNameSnapshot String
  authorUserId       String?

  attachments        NetworkAttachment[]
  messages           NetworkMessage[]

  authorUser         User?                @relation("NetworkConsultAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)
  clinic             Clinic               @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient            Patient?             @relation(fields: [patientId], references: [id], onDelete: SetNull)

  @@index([clinicId, createdAt])
  @@index([clinicId, specialty])
  @@index([clinicId, urgency])
  @@index([clinicId, status])
  @@index([patientId])
}

model NetworkMessage {
  id                 String         @id @default(uuid())
  createdAt          DateTime       @default(now())
  consultId          String
  authorNameSnapshot String
  authorUserId       String?
  body               String

  authorUser         User?          @relation("NetworkMessageAuthor", fields: [authorUserId], references: [id], onDelete: SetNull)
  consult            NetworkConsult @relation(fields: [consultId], references: [id], onDelete: Cascade)

  @@index([consultId, createdAt])
}

model NetworkAttachment {
  id                     String                @id @default(uuid())
  createdAt              DateTime              @default(now())
  consultId              String
  uploadedByNameSnapshot String?
  uploadedByUserId       String?
  kind                   NetworkAttachmentKind @default(IMAGE)
  url                    String
  mime                   String?

  consult                NetworkConsult        @relation(fields: [consultId], references: [id], onDelete: Cascade)
  uploadedByUser         User?                 @relation("NetworkAttachmentUploader", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  @@index([consultId])
  @@index([createdAt])
}

enum MembershipStatus {
  INVITED
  ACTIVE
  SUSPENDED
}

enum UserRole {
  OWNER
  ADMIN
  DOCTOR
  STAFF
}

enum EncounterStatus {
  OPEN
  LOCKED
  SIGNED
}

enum SpecialtyType {
  GENERAL
  ENDODONTICS
  PERIODONTICS
  PROSTHODONTICS
  ORTHODONTICS
  IMPLANTS
  ORAL_SURGERY
  PEDIATRIC
  RADIOLOGY
  ORTHODONTONTICS
}

enum NetworkUrgency {
  ROUTINE
  URGENT
}

enum NetworkConsultStatus {
  OPEN
  RESOLVED
}

enum NetworkAttachmentKind {
  IMAGE
  PDF
  FILE
}
